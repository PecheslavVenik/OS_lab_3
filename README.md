# Кросплатформенная программа с межпроцессной синхронизацией

## Описание

Программа демонстрирует работу с межпроцессной синхронизацией на C/C++ без использования сторонних библиотек. Поддерживает POSIX (Linux, macOS) и Windows.

## Функциональность

1. **Логирование**: Записывает события с PID и временными метками в `process_log.txt`
2. **Счетчик**: Автоматически увеличивается каждые 300 мс
3. **Интерактивное управление**: Позволяет устанавливать значение счетчика через командную строку
4. **Периодическое логирование**: Раз в секунду записывает текущее состояние
5. **Порождение процессов**: Каждые 3 секунды запускает 2 дочерних процесса с разной логикой
6. **Множественные экземпляры**: Поддержка запуска нескольких программ одновременно с автоматическим выбором лидера

## Сборка и запуск

### Linux / macOS

```bash
# Сделать скрипт исполняемым
chmod +x build.sh

# Собрать и запустить
./build.sh
```

### Windows

```cmd
REM Запустить скрипт сборки
build.cmd
```

## Запуск нескольких экземпляров

### Linux / macOS

**Вариант 1: В разных терминалах**
```bash
# Терминал 1
./process_manager

# Терминал 2
./process_manager

# Терминал 3
./process_manager
```

**Вариант 2: Из одного терминала**
```bash
# Запуск в фоновом режиме
./process_manager &
./process_manager &
./process_manager &

# Чтобы вывести на передний план:
fg
```

**Вариант 3: С помощью screen/tmux**
```bash
# Используя screen
screen -S proc1 ./process_manager
# Ctrl+A, D для отсоединения
screen -S proc2 ./process_manager

# Используя tmux
tmux new -s proc1 ./process_manager
# Ctrl+B, D для отсоединения
tmux new -s proc2 ./process_manager
```

### Windows

**Вариант 1: Разные окна командной строки**
- Откройте несколько окон cmd.exe
- В каждом запустите: `process_manager.exe`

**Вариант 2: Использование start**
```cmd
start process_manager.exe
start process_manager.exe
start process_manager.exe
```

**Вариант 3: PowerShell**
```powershell
Start-Process -FilePath ".\process_manager.exe"
Start-Process -FilePath ".\process_manager.exe"
Start-Process -FilePath ".\process_manager.exe"
```

## Команды управления

После запуска программа принимает команды:

- `set <значение>` - установить значение счетчика
  - Пример: `set 100`
- `quit` - завершить программу

## Логи

Все события записываются в файл `process_log.txt` с форматом:
```
[YYYY-MM-DD HH:MM:SS.mmm] [PID:12345] Сообщение
```

## Архитектура

### Разделяемая память
- Счетчик (long long)
- Флаги запущенных дочерних процессов
- PID процесса-лидера

### Мьютексы
- Защита доступа к счетчику
- Выбор процесса-лидера

### Потоки
1. **counter_thread**: Увеличивает счетчик каждые 300 мс
2. **log_thread**: Логирует состояние каждую секунду (только лидер)
3. **spawn_thread**: Порождает дочерние процессы каждые 3 секунды (только лидер)
4. **input_thread**: Обрабатывает пользовательский ввод

### Дочерние процессы
- **Child1**: Увеличивает счетчик на 10 и завершается
- **Child2**: Удваивает счетчик, ждет 2 секунды, делит пополам и завершается

## Требования

### Linux / macOS
- GCC или Clang с поддержкой C++11
- POSIX threads (pthread)
- POSIX shared memory

### Windows
- MinGW-w64 или Visual Studio
- Windows API

## Особенности реализации

1. **Кросплатформенность**: Использует условную компиляцию (#ifdef _WIN32)
2. **Межпроцессная синхронизация**: Shared memory + мьютексы
3. **Автоматический выбор лидера**: Первый запущенный процесс становится лидером
4. **Потокобезопасность**: Все операции с счетчиком защищены мьютексом
5. **Предотвращение гонок**: Проверка статуса дочерних процессов перед запуском новых

## Очистка ресурсов

### Linux / macOS
```bash
# Удаление shared memory (если процессы завершились некорректно)
rm /dev/shm/process_counter_shm

# Просмотр всех shared memory объектов
ls -la /dev/shm/
```

### Windows
- Ресурсы автоматически освобождаются при завершении последнего процесса

## Troubleshooting

**Проблема**: Программа не может создать shared memory  
**Решение**: Убедитесь, что у вас есть права на создание shared memory объектов

**Проблема**: "Address already in use" на Linux  
**Решение**: Удалите старые shared memory объекты: `rm /dev/shm/process_counter_shm`

**Проблема**: Дочерние процессы не запускаются на Windows  
**Решение**: Убедитесь, что путь к исполняемому файлу корректен
# OS_lab_3
